name: CodeQL Security Analysis

on:
  workflow_call:

jobs:
  analyze:
    name: Analyze C/C++ Code
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        queries: security-and-quality
    
    - name: Setup ESP-IDF for CodeQL
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.1.2
        target: esp32s3
        path: '.'
    
    - name: Create config.h from example
      run: |
        cp main/config.h.example main/config.h
    
    - name: Build project for CodeQL
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3
        idf.py build
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:cpp"
